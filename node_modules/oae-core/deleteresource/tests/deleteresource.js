casper.echo('Widget - Delete resource');

/**
 * Verify that the discussion can be deleted
 *
 * @param    {Object}    discussion         The discussion object that needs to be deleted
 */
var verifyDeleteDiscussion = function(discussion){
    casper.thenOpen('http://test.oae.com/' + discussion.profilePath, function() {
        casper.waitForSelector('.oae-clip-content', function() {
            // Open the clip where the delete button is in
            casper.click('.oae-clip-content button');
            casper.waitForSelector('.oae-trigger-deleteresource', function() {
                casper.test.assertExists('.oae-trigger-deleteresource', 'The trigger to delete the discussion is present.');
                // Click the trigger to delete button
                casper.click('.oae-trigger-deleteresource');
                casper.waitForSelector('#deleteresource-delete', function() {
                    casper.test.assertExists('#deleteresource-delete', 'The delete button exists, continue deleting the discussion.');
                    // Click the delete button
                    casper.click('#deleteresource-delete');
                    // Wait a bit for the alert to occur
                    casper.waitForSelector('#oae-notification-container > .alert-success', function(){
                        // Test if the delete was succesfull
                        casper.test.assertExists('#oae-notification-container > .alert-success', 'The deletion of the discussion was a success.');
                    });
                });
            });
        });
    });
};

/**
 * Verify that the document can be deleted
 *
 * @param    {Object}    document         The document object that needs to be deleted
 */
var verifyDeleteDocument = function(document){
    casper.thenOpen('http://test.oae.com/' + document.profilePath, function() {
        casper.waitForSelector('.oae-clip-content', function() {
            // Open the clip where the delete button is in
            casper.click('.oae-clip-content button');
            casper.waitForSelector('.oae-trigger-deleteresource', function() {
                casper.test.assertExists('.oae-trigger-deleteresource', 'The trigger to delete the document is present.');
                // Click the trigger to delete button
                casper.click('.oae-trigger-deleteresource');
                casper.waitForSelector('#deleteresource-delete', function() {
                    casper.test.assertExists('#deleteresource-delete', 'The delete button exists, continue deleting the document.');
                    // Click the delete button
                    casper.click('#deleteresource-delete');
                    // Wait a bit for the alert to occur
                    casper.waitForSelector('#oae-notification-container > .alert-success', function(){
                        // Test if the delete was succesfull
                        casper.test.assertExists('#oae-notification-container > .alert-success', 'The deletion of the document was a success.');
                    });
                });
            });
        });
    });
};

/**
 * Verify that the file can be deleted
 *
 * @param    {String}    fileUrl        The file url of the file that needs to be deleted
 */
var verifyDeleteFile = function(fileUrl){
    casper.thenOpen('http://test.oae.com/' + fileUrl, function() {
        casper.waitForSelector('.oae-clip-content', function() {
            // Open the clip where the delete button is in
            casper.click('.oae-clip-content button');
            casper.waitForSelector('.oae-trigger-deleteresource', function() {
                casper.test.assertExists('.oae-trigger-deleteresource', 'The trigger to delete the file is present.');
                // Click the trigger to delete button
                casper.click('.oae-trigger-deleteresource');
                casper.waitForSelector('#deleteresource-delete', function() {
                    casper.test.assertExists('#deleteresource-delete', 'The delete button exists, continue deleting the file.');
                    // Click the delete button
                    casper.click('#deleteresource-delete');
                    // Wait a bit for the alert to occur
                    casper.waitForSelector('#oae-notification-container > .alert-success', function(){
                        // Test if the delete was succesfull
                        casper.test.assertExists('#oae-notification-container > .alert-success', 'The deletion of the file was a success.');
                    });
                });
            });
        });
    });
};

/**
 * Verify that the link can be deleted
 *
 * @param    {Object}    link         The link object that needs to be deleted
 */
var verifyDeleteLink = function(link){
    casper.thenOpen('http://test.oae.com/' + link.profilePath, function() {
        casper.waitForSelector('.oae-clip-content', function() {
            // Open the clip where the delete button is in
            casper.click('.oae-clip-content button');
            casper.waitForSelector('.oae-trigger-deleteresource', function() {
                casper.test.assertExists('.oae-trigger-deleteresource', 'The trigger to delete the link is present.');
                // Click the trigger to delete button
                casper.click('.oae-trigger-deleteresource');
                casper.waitForSelector('#deleteresource-delete', function() {
                    casper.test.assertExists('#deleteresource-delete', 'The delete button exists, continue deleting the link.');
                    // Click the delete button
                    casper.click('#deleteresource-delete');
                    // Wait a bit for the alert to occur
                    casper.waitForSelector('#oae-notification-container > .alert-success', function(){
                        // Test if the delete was succesfull
                        casper.test.assertExists('#oae-notification-container > .alert-success', 'The deletion of the link was a success.');
                    });
                });
            });
        });
    });
};

casper.start('http://test.oae.com', function() {
    var user1 = null;
    // Create a user
    userUtil().createUsers(1, function(users) {
        user1 = users[0];
    });

    // Log in
    casper.then(function() {
        userUtil().doLogIn(user1.username, 'password');
    });

    // Make the discussion to delete
    var discussion1 = null;
    casper.then(function() {
        discussionUtil().createDiscussion(1, function(discussions) {
            discussion1 = discussions[0];

            var document1 = null;
            // Make the document to delete
            casper.then(function() {
                collabDocUtil().createCollabDoc(function(document) {
                    document1 = document;

                    // Make the file to delete
                    var fileUrl1 = null;
                    casper.then(function() {
                        contentUtil().createFile(function(fileUrl) {
                            fileUrl1 = fileUrl;
                        });
                    });

                    // Make the link to delete
                    var link1 = null;
                    casper.then(function() {
                        contentUtil().createLink(function(link) {
                            link1 = link;

                            casper.thenOpen('http://test.oae.com/me', function() {

                                // Verify discussion deletion
                                casper.then(function() {
                                    casper.echo('Verify the deletion of a discussion.');
                                    verifyDeleteDiscussion(discussion1);
                                });

                                // Verify document deletion
                                casper.then(function() {
                                    casper.echo('Verify the deletion of a document');
                                    verifyDeleteDocument(document1);
                                });

                                // Verify file deletion
                                casper.then(function() {
                                    casper.echo('Verify the deletion of a file.');
                                    verifyDeleteFile(fileUrl1);
                                });

                                // Verify link deletion
                                casper.then(function() {
                                    casper.echo('Verify the deletion of a link')
                                    verifyDeleteLink(link1);
                                });

                            });
                        });
                    });


                    // Log out again
                    casper.then(function() {
                        userUtil().doLogOut();
                    });
                });
            });

        });
    });
});

casper.run(function() {
    casper.test.done();
});
