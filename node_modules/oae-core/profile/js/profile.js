/*!
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid, showSettings, widgetData) {

        // The widget container
        var $rootel = $('#' + uid);

        // The user profile
        var userProfile = null;

        // Featured content for the user
        var featuredContent = null;

        var publications = [{
            'id': 'asdfasdfasdfasdf',
            'displayName': 'Cognitive tomography reveals complex task- independent mental representations',
            'publicationType': 'Book',
            'date': 1387210343060,
            'thumbnailUri': 'http://upload.wikimedia.org/wikipedia/en/e/ed/Hacking_Book_Cover_second_edition.jpg',
            'nrOfAuthors': '6',
            'publisher': 'Pubsub',
            'linkedContentid': 'adsfasdfasdf',
            'openAccessType': null,
            'issueNumber': '1',
            'pageBegin': '1',
            'pageEnd': '222'
        },{
            'id': 'qwerasdfasdfasdf',
            'displayName': 'Not feeling yourself: an fMRI study of impaired sensory prediction in schizophrenia',
            'publicationType': 'Composition',
            'date': 1387210343060,
            'thumbnailUri': 'http://www.earthisland.org/bya/building/graphics/bookcoverMid.png',
            'nrOfAuthors': '3',
            'publisher': 'Oxford Press',
            'linkedContentid': 'asdfasdfasdf',
            'openAccessType': 'gold',
            'issueNumber': '2',
            'pageBegin': '1',
            'pageEnd': '123'
        },{
            'id': 'asdwesdf',
            'displayName': 'Context-dependent decay of motor memories during skill acquisition',
            'publicationType': 'Book',
            'date': 1318747232000,
            'thumbnailUri': 'http://learning.eng.cam.ac.uk/pub/Public/Wolpert/Publications/JNP-cover-04.jpg',
            'nrOfAuthors': '3',
            'publisher': 'Cambridge Press',
            'linkedContentid': 'bewedsaqwefa',
            'openAccessType': 'silver',
            'issueNumber': '2',
            'pageBegin': '1',
            'pageEnd': '123'
        },{
            'id': '2erasdgddqwf',
            'displayName': 'The effect of contextual cues on the encoding of motor memories',
            'publicationType': 'Working paper',
            'date': 1387211354560,
            'thumbnailUri': 'http://maths.york.ac.uk/www/sites/default/files/images/Bayesian%20Statistics%20book%20cover.jpg',
            'nrOfAuthors': '1',
            'publisher': 'Cambridge Press',
            'linkedContentid': 'asdfasdfasdf',
            'openAccessType': 'silver',
            'issueNumber': '1',
            'pageBegin': '1',
            'pageEnd': '321'
        },{
            'id': 'asgadgwqerqwfsad',
            'displayName': 'The temporal evolution of feedback gains rapidly update to task demands',
            'publicationType': 'Journal article',
            'date': 1287211232604,
            'thumbnailUri': 'http://www.outdoorleaders.com/wp-content/uploads/2010/12/Book-cover-thumbnail.png',
            'nrOfAuthors': '11',
            'publisher': 'O\'Reilly',
            'linkedContentid': 'asdfasdfasdfasdf',
            'openAccessType': 'gold',
            'issueNumber': '5',
            'pageBegin': '1',
            'pageEnd': '431'
        }];

        //////////////////
        // PUBLICATIONS //
        //////////////////

        /**
         * Render a user's publications
         */
        var renderPublications = function() {
            oae.api.util.template().render($('#profile-publications-template', $rootel), {
                'userProfile': userProfile,
                'publications': publications
            }, $('#profile-publications-container', $rootel));
        };

        /**
         * Retrieve a user's publications
         *
         * @param  {Function}   callback   Standard callback function
         */
        var getPublications = function(callback) {
            // Retrieve the publications

            // Sort them by date
            publications.sort(function(a, b) {
                if (a.date > b.date) {
                    return -1;
                } else if (a.date < b.date) {
                    return 1;
                }
                return 0;
            });

            callback();
        };

        /////////////
        // PROFILE //
        /////////////

        /**
         * Render the profile tab
         */
        var renderProfile = function() {
            oae.api.util.template().render($('#profile-profile-template', $rootel), {
                'userProfile': userProfile,
                'featuredContent': featuredContent
            }, $('#profile-profile-container', $rootel));
        };

        /**
         * Get 3 items of featured content for the user (placeholder for publications later)
         *
         * @param  {Function}   callback   Standard callback function
         */
        var getUserFeaturedContent = function(callback) {
            $.ajax({
                'url': '/api/content/library/' + widgetData.principalId,
                'data': {
                    'limit': 3
                },
                'success': function(data) {
                    featuredContent = data.results;
                    callback();
                }
            });
        };

        /**
         * Get the user profile
         *
         * @param  {Function}   callback   Standard callback function
         */
        var getUserContext = function(callback) {
            oae.api.user.getUser(widgetData.principalId, function(err, data) {
                if (!err) {
                    userProfile = data;
                    callback();
                }
            });
        };


        ////////////////////
        // INITIALIZATION //
        ////////////////////

        /**
         * Initialize the profile widget
         */
        var initProfile = function() {
            getUserContext(function() {
                getUserFeaturedContent(function() {
                    renderProfile();

                    getPublications(function() {
                        renderPublications();
                    });
                });
            });

            $rootel.on('click', '#profile-follow', function() {
                $(document).trigger('oae.trigger.follow');
                $('#profile-follow').hide();
            });
        };

        initProfile();
    };
});
