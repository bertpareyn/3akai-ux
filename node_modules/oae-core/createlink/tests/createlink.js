casper.test.comment('Widget - Create link');

/**
 * Open the createlink modal with assertions
 */
var verifyOpenCreatelink = function() {
    casper.waitForSelector('#me-clip-container .oae-clip-content > button', function() {
        casper.click('#me-clip-container .oae-clip-content > button');
        casper.test.assertExists('.oae-trigger-createlink', 'Createlink trigger exists');
        casper.click('.oae-trigger-createlink');
        casper.wait(1000, function() {
            casper.test.assertVisible('#createlink-modal', 'Createlink pane is showing after trigger');
            casper.click('#me-clip-container .oae-clip-content > button');
        });
    });
};

var verifyCreateSingleLink = function() {
    // Verify the link dump area is there
    casper.test.assertExists('#createlink-link-dump', 'The link dump area is present');
    // Add a single link to the textarea
    casper.sendKeys('#createlink-link-dump', 'http://www.oaeproject.org', {'eventType': 'keyup'});
    //casper.captureSelector('test.png', 'button#createlink-create');
    // Verify the 'Next' button is present
    casper.test.assertExists('#createlink-next', 'The \'Next\' button is present');
    // Verify the 'Next' button enabled
    /*casper.test.assertDoesntExist('#createlink-next:disabled', 'The \'Next\' button is enabled');
    // Go to the next step
    casper.click('#createlink-next');
    // Add the link
    casper.test.assertExists('button#createlink-create', 'The \'Add link(s)\' button is present');
    casper.click('button#createlink-create');
    // Verify that the link has been uploaded by going to the content profile provided in the notification
    casper.waitForSelector('#oae-notification-container .alert', function() {
        casper.test.assertDoesntExist('#oae-notification-container .alert.alert-error', 'Link successfully added');
        // Click the first link in the notification message to go to the content profile
        casper.test.assertExists('#oae-notification-container .alert h4 + a', 'The link to the content profile is shown in the notification');
        casper.test.assertSelectorHasText('#oae-notification-container .alert h4 + a', 'http://www.oaeproject.org', 'Notification link value is \'http://www.oaeproject.org\'');
    });*/
};

casper.start('http://test.oae.com', function() {
    // Create a couple of users to test createlink with
    var user1 = null;
    userUtil().createUsers(1, function(users) {
        user1 = users[0];
    });

    // Login with that user
    casper.then(function() {
        userUtil().doLogIn(user1.username, 'password');
    });

    // Open the createlink modal
    casper.then(function() {
        casper.echo('Verify createlink modal', 'INFO');
        verifyOpenCreatelink();
    });

    // Verify creating a link
    casper.then(function() {
        casper.echo('Verify creating single link', 'INFO');
        verifyCreateSingleLink();
    });

    // Log out at the end of the test
    casper.then(function() {
        userUtil().doLogOut();
    });
});

casper.run(function() {
    this.test.done();
});
