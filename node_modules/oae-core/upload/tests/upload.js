casper.test.comment('Widget - Upload');

/**
 * Open the upload modal with assertions
 */
var verifyOpenUpload = function() {
    casper.waitForSelector('#me-clip-container .oae-clip-content > button', function() {
        casper.click('#me-clip-container .oae-clip-content > button');
        casper.test.assertExists('.oae-trigger-upload', 'Upload trigger exists');
        casper.click('.oae-trigger-upload');
        casper.wait(1000, function() {
            casper.test.assertVisible('#upload-modal', 'Upload pane is showing after trigger');
            casper.click('#me-clip-container .oae-clip-content > button');
        });
    });
};

/**
 * Open the upload modal
 */
var openUpload = function() {
    casper.waitForSelector('#me-clip-container .oae-clip-content > button', function() {
        casper.click('#me-clip-container .oae-clip-content > button');
        casper.click('.oae-trigger-upload');
        casper.wait(1000, function() {
            casper.click('#me-clip-container .oae-clip-content > button');
        });
    });
};

/**
 * Does a quick smoke test of the upload workflow
 *     - Select a file
 *     - Upload the file
 *     - Follow notification link and check title matches file
 */
var verifyUploadSingleFile = function() {
    // Verify that the form is present
    casper.test.assertExists('#upload-dropzone form', 'The upload form is present');
    // Select a file to upload
    casper.fill('#upload-dropzone form', {
        'file': 'tests/casperjs/data/balloons.jpg'
    }, false);
    // Verify that the correct file is shown in the list
    casper.test.assertExists('ul#upload-selected-container li', 'The selected file was rendered in a list');
    // Upload the file
    casper.test.assertExists('button#upload-upload', 'The \'Upload file(s)\' button is present');
    casper.click('button#upload-upload');
    // Verify that the file has been uploaded by going to the content profile provided in the notification
    casper.waitForSelector('#oae-notification-container .alert', function() {
        casper.test.assertDoesntExist('#oae-notification-container .alert.alert-error', 'File successfully uploaded');
        // Click the first link in the notification message to go to the content profile
        casper.test.assertExists('#oae-notification-container .alert h4 + a', 'The link to the content profile is shown in the notification');
        casper.click('#oae-notification-container .alert h4 + a');
        // Wait a couple of seconds for the pageload
        casper.wait(2000, function() {
            casper.test.assertSelectorHasText('#content-clip-container h1', 'balloons.jpg', 'The uploaded file has the correct title');
        });
    });
};

/**
 * Does a quick smoke test of the upload workflow
 *     - Select a file
 *     - Upload the file
 *     - Follow notification link and check title matches file
 */
var verifyUploadMultipleFiles = function() {
    // Verify that the form is present
    casper.test.assertExists('#upload-dropzone form', 'The upload form is present');
    // Select a file to upload
    casper.fill('#upload-dropzone form', {
        'file': ['tests/casperjs/data/balloons.jpg']
    }, false);
    casper.fill('#upload-dropzone form', {
        'file': ['tests/casperjs/data/apereo.jpg']
    }, false);
    // Verify that the correct files are shown in the list
    casper.test.assertExists('ul#upload-selected-container li', 'The selected file was rendered in a list');
    // Upload the files
    casper.test.assertExists('button#upload-upload', 'The \'Upload file(s)\' button is present');
    casper.click('button#upload-upload');
    // Verify that the file has been uploaded by going to the content profile provided in the notification
    casper.waitForSelector('#oae-notification-container .alert', function() {
        casper.test.assertDoesntExist('#oae-notification-container .alert.alert-error', 'Files successfully uploaded');
        casper.click('#oae-notification-container .close');
    });
};

/**
 * Verify that a selected file can be renamed before upload
 */
var verifyRenameSelectedFile = function() {
    // Select a file to upload
    casper.fill('#upload-dropzone form', {
        'file': 'tests/casperjs/data/balloons.jpg'
    }, false);
    // Verify that the file is shown in the list
    casper.test.assertExists('#upload-selected-container li', 'The selected file was rendered in a list');
    casper.test.assertExists('#upload-modal .upload-selected-name', 'The editable file name field is present');
    casper.test.assertSelectorHasText('#upload-modal .upload-selected-name', 'balloons.jpg', 'Selected file has name \'balloons.jpg\'');
    // CasperJS has an issue clicking elements that have tabindex="0" specified, remove it.
    casper.evaluate(function() {
        document.getElementsByClassName('upload-selected-name')[0].removeAttribute('tabindex');
    });
    casper.click('.upload-selected-name');

    // Wait till the form has been injected into the DOM
    casper.waitForSelector('#upload-modal .upload-selected-name form', function() {
        // Check if the form is shown after clicking the editable field
        casper.test.assertExists('#upload-modal .upload-selected-name form', 'The file name form is present after click');
        // fill the form
        casper.fill('#upload-modal .upload-selected-name form', {
            'value': 'Balloons in the sky'
        }, false);
        casper.click('html');
        // Verify that the new name is shown in the list
        casper.test.assertSelectorHasText('.upload-selected-name', 'Balloons in the sky', 'Renamed file has name \'Balloons in the sky\'');
        // Upload the file
        casper.test.assertExists('button#upload-upload', 'The \'Upload file(s)\' button is present');
        casper.click('button#upload-upload');
        // Verify that the file has been uploaded by going to the content profile provided in the notification
        casper.waitForSelector('#oae-notification-container .alert', function() {
            casper.test.assertDoesntExist('#oae-notification-container .alert.alert-error', 'File successfully uploaded');
            // Click the first link in the notification message to go to the content profile
            casper.test.assertExists('#oae-notification-container .alert h4 + a', 'The link to the content profile is shown in the notification');
            casper.test.assertSelectorHasText('#oae-notification-container .alert h4 + a', 'Balloons in the sky', 'Notification link value is \'Balloons in the sky\'');
            casper.click('#oae-notification-container .alert h4 + a');
            // Wait a couple of seconds for the pageload
            casper.wait(2000, function() {
                // Verify that the new name is used for the file
                casper.test.assertSelectorHasText('#content-clip-container h1', 'Balloons in the sky', 'The uploaded file has the correct renamed title');
            });
        });
    });
};

casper.start('http://test.oae.com', function() {
    // Create a couple of users to test upload with
    var user1 = null;
    userUtil().createUsers(1, function(users) {
        user1 = users[0];
    });

    // Login with that user
    casper.then(function() {
        userUtil().doLogIn(user1.username, 'password');
    });

    // Open the upload modal
    casper.then(function() {
        casper.echo('Verify upload modal', 'INFO');
        verifyOpenUpload();
    });

    // Verify uploading a file
    casper.then(function() {
        casper.echo('Verify uploading single file', 'INFO');
        verifyUploadSingleFile();
    });

    // Verify uploading multiple files
    casper.then(function() {
        casper.echo('Verify uploading multiple files', 'INFO');
        casper.thenOpen('http://test.oae.com/me', function() {
            casper.then(openUpload);
            casper.then(verifyUploadMultipleFiles);
        });
    });

    // Verify renaming files
    casper.then(function() {
        casper.echo('Verify renaming selected file', 'INFO');
        casper.thenOpen('http://test.oae.com/me', function() {
            casper.then(openUpload);
            casper.then(verifyRenameSelectedFile);
        });
    });

    // Log out at the end of the test
    casper.then(function() {
        userUtil().doLogOut();
    });
});

casper.run(function() {
    this.test.done();
});
