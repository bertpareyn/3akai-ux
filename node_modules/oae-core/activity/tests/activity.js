casper.echo('Activity - Test');

/**
 * Verify that the activity create discussion is shown
 *
 * @param    {Object}    discussion1    The discussion Object of the first discussion that was made
 * @param    {Object}    user           The user object of the user that made the discussions
 * @param    {Number}    index          The index of the discussions activity in the activity list (higher if it was made first, lower if it was made last)
 */
var verifyCreatedDiscussions = function(discussion1, user, index) {
    // Assert the sentence '"username" started the discussion "discussionname"'
    // Assert also the references to the user and discussion
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + user.profilePath + '"]', 'The ref to the user in the activity "\'username\' started the discussion \'discussionname\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', user.displayName,  'The name of the user in the activity "\'username\' started the discussion \'discussionname\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary','started the discussion', '"started the discussion" sentence in the activity "\'username\' started the discussion \'discussionname\'" is present');
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + discussion1.profilePath + '"]', 'The ref to the discussion in the activity "\'username\' started the discussion \'discussionname\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', discussion1.displayName, 'The name of the discussion in the activity "\'username\' started the discussion \'discussionname\'" is present');
    // Assert that the sentence "and 3 others" is added if four of the same activity are made
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary','and 3 others', 'The sentence "and 3 others" is present if 4 of the same activity are made');
    // The normal preview has a large thumbnail of the activity
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.oae-thumbnail-large', 'The first created activity has a large icon');
    // The third of the same activity doesn't have a large thumbnail
    casper.test.assertDoesntExist('ul.oae-list>li:nth-child(' + index + ') div.activity-multiple div.oae-thumbnail-large', 'The third created activity doesn\'t have a large icon');
    // The third of the same activity does have a small thumbnail
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-multiple div.oae-thumbnail.icon-oae-discussion', 'The third created activity has a small icon');
};

/**
 * Verify that the activity create group is shown
 *
 * @param    {Object}    group     The group object of the created group
 * @param    {Object}    user      The user object of the user that made the group
 * @param    {Number}    index     The index of the group activity in the activity list (higher if it was made first, lower if it was made last)
 */
var verifyCreatedGroup = function(group, user, index) {
    // Assert the senctence '"username" created the group "groupname"'
    // Assert also the references to the user and the group
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + user.profilePath + '"]', 'The ref to the user in the activity "\'username\' created the group \'groupname\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', user.displayName, 'The name of the user in the activity "\'username\' created the group \'groupname\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary', 'created the group', '"created the group" sentence in the activity "\'username\' created the group \'groupname\'" is present');
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + group.profilePath + '"]', 'The ref to the group in the activity "\'username\' created the group \'groupname\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', group.displayName, 'The name of the group in the activity "\'username\' created the group \'groupname\'" is present');
};

/**
 * Verify that the activity added user to a group is shown
 *
 * @param    {Object}    group      The group object that the user is added to
 * @param    {Object}    user1      The user object of the user that added user2 to the group
 * @param    {Object}    user2      The user object of the user that was added to the group
 * @param    {Number}    index      The index of the group activity in the activity list (higher if it was made first, lower if it was made last)
 */
var verifyAddedUserToGroup = function(group, user1, user2, index) {
    // Assert the senctence '"username" added "username2" to the group "groupname"'
    // Assert also the references to the user and the group
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + user1.profilePath + '"]', 'The ref to the user in the activity "\'username\' added \'username2\' to the group \'groupname\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', user1.displayName, 'The name of the user in the activity "\'username\' added \'username2\' to the group \'groupname\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary', 'added ' + user2.displayName + ' to the group', '"added \'username2\' to the group" in the activity "\'username\' added \'username2\' to the group \'groupname\'" is present');
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + group.profilePath + '"]', 'The ref to the group in the activity "\'username\' added \'username2\' to the group \'groupname\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', group.displayName, 'The name of the group in the activity "\'username\' added \'username2\' to the group \'groupname\'" is present');
};

/**
 * Verify that the activity added you to a group is shown
 *
 * @param    {Object}    group      The group object that the user is added to
 * @param    {Object}    user1      The user object of the user that added user2 to the group
 * @param    {Object}    user2      The user object of the user that was added to the group
 * @param    {Number}    index      The index of the group activity in the activity list (higher if it was made first, lower if it was made last)
 */
var verifyAddedYouToGroup = function(group, user, index) {
    // Assert the senctence '"username" added you to the group "groupname"'
    // Assert also the references to the user and the group
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + user.profilePath + '"]', 'The ref to the user in the activity "\'username\' added you to the group \'groupname\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', user.displayName, 'The name of the user in the activity "\'username\' added you to the group \'groupname\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary', 'added you to the group', '"added you to the group" in the activity "\'username\' added you to the group \'groupname\'" is present');
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + group.profilePath + '"]', 'The ref to the group in the activity "\'username\' added you to the group \'groupname\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', group.displayName, 'The name of the group in the activity "\'username\' added you to the group \'groupname\'" is present');
};

/**
 * Verify that the activity changed the visibility of a group is shown
 *
 * @param    {Object}    group      The group object of the group that had it's visibility changed
 * @param    {Object}    user       The user object of the user that changed the visibility
 * @param    {Number}    index      The index of the group activity in the activity list (higher if it was made first, lower if it was made last)
 */
var verifyChangeVisibility = function(group, user, index) {
    // Assert the senctence '"username" changed the visibility of the group "groupname" to private'
    // Assert also the references to the user and the group
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + user.profilePath + '"]', 'The ref to the user in the activity "\'username\' changed the visibility of the group \'groupname\' to private" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', user.displayName, 'The name of the user in the activity "\'username\' changed the visibility of the group \'groupname\' to private" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary', 'changed the visibility of the group', '"changed the visibility of the group" sentence in the activity "\'username\' changed the visibility of the group \'groupname\' to private" is present');
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + group.profilePath + '"]', 'The ref to the group in the activity "\'username\' changed the visibility of the group \'groupname\' to private" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', group.displayName, 'The name of the group in the activity "\'username\' changed the visibility of the group \'groupname\' to private" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary', 'to private', '"to private" sentence in the activity "\'username\' changed the visibility of the group \'groupname\' to private" is present');
};

/*
 * Verify that the activity uploaded a file is shown
 *
 * @param    {String}    fileUrl    The Url to the file
 * @param    {Object}    user       The user object of the user that uploaded the file
 * @param    {Number}    index      The index of the group activity in the activity list (higher if it was made first, lower if it was made last)
 */
var verifyUploadedFile = function(fileUrl, user, index) {
    // Assert the senctence '"username" uploaded "filename"'
    // Assert also the references to the user and the file
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + user.profilePath + '"]', 'The ref to the user in the activity "\'username\' uploaded \'filename\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', user.displayName, 'The name of the user in the activity "\'username\' uploaded \'filename\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary', ' uploaded ', '"uploaded" in the activity "\'username\' uploaded \'filename\'" is present');
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + fileUrl + '"]',  'The ref to the file in the activity "\'username\' uploaded \'filename\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', 'balloons.jpg', 'The name of the file in the activity "\'username\' uploaded \'filename\'" is present');
};

/*
 * Verify that the activity commented on a file is shown and the comment itself
 *
 * @param    {String}    fileUrl    The Url to the file
 * @param    {Object}    user       The user object of the user that commented on the file
 * @param    {String}    comment    The comment placed on the file
 * @param    {Number}    index      The index of the comment activity in the activity list (higher if it was made first, lower if it was made last)
 */
var verifycommentOnFile = function(fileUrl, user, comment, index) {
    // Assert the senctence '"username" commented on the file "filename"'
    // Assert also the references to the user and the file
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + user.profilePath + '"]', 'The ref to the user in the activity "\'username\' commented on the file \'filename\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', user.displayName, 'The name of the user in the activity "\'username\' commented on the file \'filename\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary', ' commented on the file ', '"commented on the file" in the activity "\'username\' commented on the file \'filename\'" is present');
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + fileUrl + '"]', 'The ref to the file in the activity "\'username\' commented on the file \'filename\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', 'balloons.jpg', 'The name of the file in the activity "\'username\' commented on the file \'filename\'" is present');
    // Test if the comment is shown too
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-comment-container', comment, 'The comment on the file is present in the activity section');
};

/*
 * Verify that the activity posted to a discussion is shown and the post itself
 *
 * @param    {Object}    discussion     The discussion object of the discussion that was posted to
 * @param    {Object}    user           The user object of the user that placed the post
 * @param    {String}    post           The post placed to the discussion
 * @param    {Number}    index          The index of the post activity in the activity list (higher if it was made first, lower if it was made last)
 */
var verifyPostToDiscussion = function(discussion, user, post, index) {
    // Assert the senctence '"username" posted to the discussion "discussionname"'
    // Assert also the references to the user and the discussion
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + user.profilePath + '"]', 'The ref to the user in the activity "\'username\' posted to the discussion \'filename\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', user.displayName, 'The name of the user in the activity "\'username\' posted to the discussion \'filename\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary', ' posted to the discussion ', '"posted to the discussion" in the activity "\'username\' posted to the discussion \'filename\'" is present');
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + discussion.profilePath + '"]', 'The ref to the file in the activity "\'username\' posted to the discussion \'filename\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', discussion.displayName, 'The name of the file in the activity "\'username\' posted to the discussion \'filename\'" is present');
    // Test if the post is shown too
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-comment-container', post, 'The post to the discussion is present in the activity section');
};

/*
 * Verify that the activity updated a group is shown
 *
 * @param    {Object}    group      The group object of the group that was updated
 * @param    {Object}    user       The user object of the user that updated the group
 * @param    {Number}    index      The index of the update activity in the activity list (higher if it was made first, lower if it was made last)
 */
var verifyUpdateGroup = function(group, user, index) {
    // Assert the senctence '"username" updated the group "groupname"'
    // Assert also the references to the user and the group
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + user.profilePath + '"]', 'The ref to the user in the activity "\'username\' updated the group \'filename\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', user.displayName, 'The name of the user in the activity "\'username\' updated the group \'filename\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary', ' updated the group ', '"updated the group" in the activity "\'username\' updated the group \'filename\'" is present');
    casper.test.assertExists('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a[href="' + group.profilePath + '"]', 'The ref to the file in the activity "\'username\' updated the group \'filename\'" is present');
    casper.test.assertSelectorHasText('ul.oae-list>li:nth-child(' + index + ') div.activity-summary>a', group.displayName, 'The name of the file in the activity "\'username\' updated the group \'filename\'" is present');
};

casper.start('http://test.oae.com', function() {
    // Need these to test post to discussion and comment to file
    var post = 'Post!';
    var comment = 'Comment!';
    // Create a user to make activities with and test them
    var user1 = null;
    userUtil().createUsers(2, function(users) {
        user1 = users[0];
        user2 = users[1];
    });

    // Log in
    casper.then(function() {
        userUtil().doLogIn(user1.username, 'password');
    });

    var discussion1 = null;
    casper.then(function() {

        // Need to make at least 4 discussions for the small icon for the third activity to appear
        // I only test on the discussion1 if every reference etc is right, so I don't need to save the rest
        discussionUtil().createDiscussion(4, function(discussions) {
            discussion1 = discussions[0];
            
            casper.thenOpen('http://test.oae.com/me', function() {
                casper.waitForSelector('.activity-widget', function() {
                    casper.echo('verify the created discussion activity', 'INFO');
                    verifyCreatedDiscussions(discussion1, user1, 1);
                });
            });
        });

        // Make a group tot test the group activities with
        var group1 = null;
        casper.then(function() {
            groupUtil().createGroup([], [], function(group) {
                group1 = group;
            
                casper.thenOpen('http://test.oae.com/me', function() {
                    casper.waitForSelector('.activity-widget', function() {
                        casper.echo('verify the created group activity', 'INFO');
                        verifyCreatedGroup(group1, user1, 1);
                    });
                });
            });
        });

        // Change the visibily in the group
        casper.then(function() {
            groupUtil().changeVisibility('private', group1);

            casper.thenOpen('http://test.oae.com/me', function() {
                casper.waitForSelector('.activity-widget', function() {
                    casper.echo('verify the changed visibility activity', 'INFO');
                    verifyChangeVisibility(group1, user1, 1);
                });
            });
        });

        // Add user2 to the group
        casper.then(function() {
            groupUtil().addUserToGroup(user2.username, group1.profilePath);

            casper.thenOpen('http://test.oae.com/me', function() {
                casper.waitForSelector('.activity-widget', function() {
                    casper.echo('verify the added user to group activity', 'INFO');
                    verifyAddedUserToGroup(group1, user1, user2, 1);
                });
            });
        });

        // Make a file to test the upload activity with
        var fileUrl1 = null;
        casper.then(function() {
            contentUtil().createFile('tests/casperjs/data/balloons.jpg',function(fileUrl) {
                fileUrl1 = fileUrl;

                casper.thenOpen('http://test.oae.com/me', function() {
                    casper.waitForSelector('.activity-widget', function() {
                        casper.echo('verify the uploaded file activity', 'INFO');
                        verifyUploadedFile(fileUrl, user1, 1);
                    });
                });
            });
        });

        // Comment on the made file
        casper.then(function() {
            contentUtil().commentOnFile(fileUrl1, comment);

            casper.thenOpen('http://test.oae.com/me', function() {
                casper.waitForSelector('.activity-widget', function() {
                    casper.echo('verify the comment on file activity', 'INFO');
                    verifycommentOnFile(fileUrl1, user1, comment, 1);
                });
            });
        });

        // Post to discussion1
        casper.then(function() {
            discussionUtil().postToDiscussion(discussion1, post);

            casper.thenOpen('http://test.oae.com/me', function() {
                casper.waitForSelector('.activity-widget', function() {
                    casper.echo('verify the post to discussion activity', 'INFO');
                    verifyPostToDiscussion(discussion1, user1, post, 1);
                });
            });
        });

        // 1 the description of the group
        casper.then(function() {
            groupUtil().updateGroupDescription(group1);

            casper.thenOpen('http://test.oae.com/me', function() {
                casper.waitForSelector('.activity-widget', function() {
                    casper.echo('verify the updated group activity', 'INFO');
                    verifyUpdateGroup(group1, user1, 1);
                });
            });
        });

        // Verify that the added you to group activity exists
        casper.then(function() {
            // Change to user2 to test this
            userUtil().doLogOut();
            userUtil().doLogIn(user2.username, 'password');
            casper.waitForSelector('.activity-widget', function() {

                casper.thenOpen('http://test.oae.com/me', function() {
                    casper.waitForSelector('.activity-widget', function() {
                        casper.echo('verify the added you to group activity', 'INFO');
                        // There are 2 activities in user2, added to group and updated the group.
                        // The added you to group that needs testing was made first, so use n=2 
                        // (It was made first and so is on the bottom of the list)
                        verifyAddedYouToGroup(group1, user1, 2);
                    });
                });
            });
        });
    });

    // Log out
    casper.then(function() {
        userUtil().doLogOut();
    });
});

casper.run(function() {
    casper.test.done();
});
