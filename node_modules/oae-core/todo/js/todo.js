/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid, showSettings, widgetData) {

        // The widget container
        var $rootel = $('#' + uid);

        // Keep track of the todos for the user
        var todos = [];

        /**
         * Renders the todos in the list
         */
        var renderTodos = function() {
            oae.api.util.template().render($('#todo-template', $rootel), {
                'todos': todos
            }, $('#todo-container', $rootel));

            // Focus the 'add todo' input field
            $('#todo-form input', $rootel).focus();
        };

        /**
         * Mark a todo as `done` or `todo`
         */
        var setUpMarkAsdone = function() {
            $rootel.on('change', '#todo-widget input[type="checkbox"]', function() {
                var todoID = $(this).attr('data-id');

                $.ajax({
                    'url': '/api/todo/' + todoID + '/done',
                    'type': 'POST',
                    'data': {
                        'done': $(this).is(':checked')
                    },
                    'success': function(data) {
                        $.each(todos, function(i, todo) {
                            if (todo.id === data.id) {
                                todos[i].done = data.done;
                            }
                        });
                        renderTodos();
                    },
                    'error': function() {
                        oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__MARK_TODO__', 'todo'),
                        oae.api.i18n.translate('__MSG__MARK_TODO_FAILED__', 'todo'),
                        'error');
                    }
                });
            });
        };

        /**
         * Add a new todo to the list
         */
        var setUpAddTodo = function() {
            $(document).on('submit', '#todo-form', function() {
                $.ajax({
                    'url': '/api/todo/todos',
                    'type': 'POST',
                    'data': {
                        'description': $('#todo-form #todo-description').val()
                    },
                    'success': function(data) {
                        todos.push(data);
                        renderTodos();
                    },
                    'error': function(a,b,c) {
                        oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__ADD_TODO__', 'todo'),
                        oae.api.i18n.translate('__MSG__ADD_TODO_FAILED__', 'todo'),
                        'error');
                    }
                });

                return false;
            });
        };

        /**
         * Retrieve the user's todo list
         */
        var getTodos = function() {
            $.ajax({
                'url': '/api/todo/todos',
                'type': 'GET',
                'success': function(data) {
                    todos = data;
                    renderTodos();
                },
                'error': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__GET_TODOS__', 'todo'),
                        oae.api.i18n.translate('__MSG__GET_TODOS_FAILED__', 'todo'),
                        'error');
                }
            });
        };

        /**
         * Initialize the todo widget
         */
        var initToDo = function() {
            setUpAddTodo();
            setUpMarkAsdone();

            getTodos();
        };

        initToDo();

    };
});
