casper.test.comment('Widget - Left hand navigation');

/**
 * Verify that all personal dashboard navigation is present
 */
var verifyMeNavigation = function() {
    // Verify the left hand navigation container exists
    casper.test.assertExists('#lhnavigation-navigation', 'The left hand navigation container is present');
    // Verify the left hand navigation list exists
    casper.test.assertExists('#lhnavigation-navigation ul.nav-list', 'The left hand navigation list is present');
    // Verify the left hand navigation has activity, library, discussions and groups
    casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="dashboard"]', 'The left hand navigation list item for recent activity is present');
    casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="dashboard"] a[href="/me/dashboard"]', 'The left hand navigation list item for recent activity has a link');
    casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="library"]', 'The left hand navigation list item for the library is present');
    casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="library"] a[href="/me/library"]', 'The left hand navigation list item for the library has a link');
    casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="discussions"]', 'The left hand navigation list item for discussions is present');
    casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="discussions"] a[href="/me/discussions"]', 'The left hand navigation list item for discussions has a link');
    casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="groups"]', 'The left hand navigation list item for groups is present');
    casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="groups"] a[href="/me/groups"]', 'The left hand navigation list item for groups has a link');
};

/**
 * Verify that all personal dashboard navigation for another user is present
 */
var verifyOtherUserNavigation = function(profilePath) {
    casper.waitForSelector('#lhnavigation-navigation', function() {
        // Verify the left hand navigation container exists
        casper.test.assertExists('#lhnavigation-navigation', 'The left hand navigation container is present');
        // Verify the left hand navigation list exists
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list', 'The left hand navigation list is present');
        // Verify the left hand navigation has library, discussions and groups and the recent activity is hidden
        casper.test.assertDoesntExist('#lhnavigation-navigation ul.nav-list li[data-id="' + profilePath + '/dashboard"]', 'Recent activity is not shown when viewing other user\'s profile');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="library"]', 'The left hand navigation list item for the library is present');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="library"] a[href="' + profilePath + '/library"]', 'The left hand navigation list item for the library has a link');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="discussions"]', 'The left hand navigation list item for discussions is present');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="discussions"] a[href="' + profilePath + '/discussions"]', 'The left hand navigation list item for discussions has a link');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="groups"]', 'The left hand navigation list item for groups is present');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="groups"] a[href="' + profilePath + '/groups"]', 'The left hand navigation list item for groups has a link');
    });
};

/**
 * Verify that all group navigation is present
 *
 * @param  {String}   profilePath   The path to the group profile
 */
var verifyGroupNavigation = function(profilePath) {
    casper.waitForSelector('#lhnavigation-navigation', function() {
        // Verify the left hand navigation container exists
        casper.test.assertExists('#lhnavigation-navigation', 'The left hand navigation container is present');
        // Verify the left hand navigation list exists
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list', 'The left hand navigation list is present');
        // Verify the left hand navigation has activity, library, discussions and members
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="activity"]', 'The left hand navigation list item for recent activity is present');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="activity"] a[href="' + profilePath + '/activity"]', 'The left hand navigation list item for recent activity has a link');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="library"]', 'The left hand navigation list item for the library is present');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="library"] a[href="' + profilePath + '/library"]', 'The left hand navigation list item for the library has a link');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="discussions"]', 'The left hand navigation list item for discussions is present');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="discussions"] a[href="' + profilePath + '/discussions"]', 'The left hand navigation list item for discussions has a link');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="members"]', 'The left hand navigation list item for members is present');
        casper.test.assertExists('#lhnavigation-navigation ul.nav-list li[data-id="members"] a[href="' + profilePath + '/members"]', 'The left hand navigation list item for members has a link');
    });
};

casper.start('http://test.oae.com', function() {
    // Create a couple of users to test with
    var user1 = null;
    var user2 = null;
    userUtil().createUsers(2, function(users) {
        user1 = users[0];
        user2 = users[1];
    });

    // Login with that user
    casper.then(function() {
        userUtil().doLogIn(user1.username, 'password');
    });

    // Verify that all personal dashboard navigation is present
    casper.then(function() {
        casper.echo('Verify /me navigation', 'INFO');
        verifyMeNavigation();
    });

    // Verify that all personal dashboard navigation is present when viewing another user's profile
    casper.then(function() {
        casper.echo('Verify /user/:tenantID/:userID navigation', 'INFO');
        casper.thenOpen('http://test.oae.com' + user2.profilePath, function() {
            verifyOtherUserNavigation(user2.profilePath);
        });
    });

    // Verify that all group navigation is present
    casper.then(function() {
        casper.echo('Verify /group/:tenantID/:groupID navigation', 'INFO');
        groupUtil().createGroup(function(group) {
            casper.thenOpen('http://test.oae.com' + group.profilePath, function() {
                verifyGroupNavigation(group.profilePath);
            });
            // Log out at the end of the test
            casper.then(function() {
                userUtil().doLogOut();
            });
        });
    });
});

casper.run(function() {
    this.test.done();
});
