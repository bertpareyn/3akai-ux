casper.echo('Deleteresource - Test');

/**
 * Verify that the discussion can be deleted within the discussionslibrary
 *
 * @param    {Object}    discussion         The discussion object that needs to be deleted
 */
var verifyDeleteDiscussions = function(discussion){
    casper.thenOpen('http://test.oae.com/me/discussions', function() {
        casper.waitForSelector('.oae-list-grid', function() {
            // Don't use nth-child(1) that is the start discussion section
            casper.test.assertExists('.oae-list-grid>li:nth-child(2) a[title="' + discussion.displayName + '"]', 'The discussion that is going to be removed exists.');
            casper.test.assertExists('.oae-list-grid>li:nth-child(2) input[type="checkbox"]', 'The checkbox for the discussion that needs to be removed exists.');
            // Click the checkbox of this discussion
            casper.click('.oae-list-grid>li:nth-child(2) input[type="checkbox"]');
            casper.waitForSelector('#discussionslibrary-widget button.oae-trigger-deleteresources', function() {
                // Click the trigger to delete button
                casper.click('#discussionslibrary-widget button.oae-trigger-deleteresources');
                casper.waitForSelector('button#deleteresources-manage-delete-system', function() {
                    casper.test.assertExists('#deleteresources-overview-container a[title="' + discussion.displayName + '"]', 'The right discussion has been chosen for removing.');
                    casper.test.assertExists('button#deleteresources-manage-delete-system', 'The delete from system button is present.');
                    casper.test.assertExists('button#deleteresources-manage-delete-system', 'The delete from library button is present.');
                    // Click the delete button
                    casper.click('button#deleteresources-manage-delete-system');
                    casper.waitForSelector('#oae-notification-container > .alert-success', function() {
                        // Test if the delete was succesfull
                        casper.test.assertExists('#oae-notification-container > .alert-success', 'Succesfsully deleted the discussion.');
                    });
                });
            });
        });
    });
};

/**
 * Verify that the document can be deleted within the contentlibrary
 *
 * @param    {Object}    document         The document object that needs to be deleted
 */
var verifyDeleteDocuments = function(document){
    casper.thenOpen('http://test.oae.com/me/library', function() {
        casper.waitForSelector('.oae-list-grid', function() {
            // Don't use nth-child(1) that is the start content section
            casper.test.assertExists('.oae-list-grid>li:nth-child(2) a[title="' + document.displayName + '"]', 'The document that is going to be removed exists.');
            casper.test.assertExists('.oae-list-grid>li:nth-child(2) input[type="checkbox"]', 'The checkbox for the document that needs to be removed exists.');
            // Click the checkbox of this document
            casper.click('.oae-list-grid>li:nth-child(2) input[type="checkbox"]');
            casper.waitForSelector('#contentlibrary-widget button.oae-trigger-deleteresources', function() {
                // Click the trigger to delete button
                casper.click('#contentlibrary-widget button.oae-trigger-deleteresources');
                casper.waitForSelector('button#deleteresources-manage-delete-system', function() {
                    casper.test.assertExists('#deleteresources-overview-container a[title="' + document.displayName + '"]', 'The right document has been chosen for removing.');
                    casper.test.assertExists('button#deleteresources-manage-delete-system', 'The delete from system button is present.');
                    casper.test.assertExists('button#deleteresources-manage-delete-system', 'The delete from library button is present.');
                    // Click the delete button
                    casper.click('button#deleteresources-manage-delete-system');
                    casper.waitForSelector('#oae-notification-container > .alert-success', function() {
                        // Test if the delete was succesfull
                        casper.test.assertExists('#oae-notification-container > .alert-success', 'Successfully deleted the document.');
                    });
                });
            });
        });
    });
};

/**
 * Verify that the file can be deleted within the contentlibrary
 *
 * @param    {String}    fileUrl        The file object that needs to be deleted
 */
var verifyDeleteFiles = function(fileUrl){
    casper.thenOpen('http://test.oae.com/me/library', function() {
        casper.waitForSelector('.oae-list-grid', function() {
            // Don't use nth-child(1) that is the start content section
            casper.test.assertExists('.oae-list-grid>li:nth-child(2) a[href="' + fileUrl + '"]', 'The file that is going to be removed exists.');
            casper.test.assertExists('.oae-list-grid>li:nth-child(2) input[type="checkbox"]', 'The checkbox for the file that needs to be removed exists.');
            // Click the checkbox of this file
            casper.click('.oae-list-grid>li:nth-child(2) input[type="checkbox"]');
            casper.waitForSelector('#contentlibrary-widget button.oae-trigger-deleteresources', function() {
                // Click the trigger to delete button
                casper.click('#contentlibrary-widget button.oae-trigger-deleteresources');
                casper.waitForSelector('button#deleteresources-manage-delete-system', function() {
                    casper.test.assertExists('#deleteresources-overview-container a[href="' + fileUrl + '"]', 'The right file has been chosen for removing.');
                    casper.test.assertExists('button#deleteresources-manage-delete-system', 'The delete from system button is present.');
                    casper.test.assertExists('button#deleteresources-manage-delete-system', 'The delete from library button is present.');
                    // Click the delete button
                    casper.click('button#deleteresources-manage-delete-system');
                    casper.waitForSelector('#oae-notification-container > .alert-success', function() {
                        // Test if the delete was succesfull
                        casper.test.assertExists('#oae-notification-container > .alert-success', 'Successfully deleted the file.');
                    });
                });
            });
        });
    });
};

/**
 * Verify that the link can be deleted within the contentlibrary
 *
 * @param    {Object}    link         The link object that needs to be deleted
 */
var verifyDeleteLinks = function(link){
    casper.thenOpen('http://test.oae.com/me/library', function() {
        casper.waitForSelector('.oae-list-grid', function() {
            // Don't use nth-child(1) that is the start content section
            casper.test.assertExists('.oae-list-grid>li:nth-child(2) a[title="' + link.displayName + '"]', 'The link that is going to be removed exists.');
            casper.test.assertExists('.oae-list-grid>li:nth-child(2) input[type="checkbox"]', 'The checkbox for the link that needs to be removed exists.');
            // Click the checkbox of this link
            casper.click('.oae-list-grid>li:nth-child(2) input[type="checkbox"]');
            casper.waitForSelector('#contentlibrary-widget button.oae-trigger-deleteresources', function() {
                // Click the trigger to delete button
                casper.click('#contentlibrary-widget button.oae-trigger-deleteresources');
                casper.waitForSelector('button#deleteresources-manage-delete-system', function() {
                    casper.test.assertExists('#deleteresources-overview-container a[title="' + link.displayName + '"]', 'The right link has been chosen for removing.');
                    casper.test.assertExists('button#deleteresources-manage-delete-system', 'The delete from system button is present.');
                    casper.test.assertExists('button#deleteresources-manage-delete-system', 'The delete from library button is present.');
                    // Click the delete button
                    casper.click('button#deleteresources-manage-delete-system');
                    casper.waitForSelector('#oae-notification-container > .alert-success', function() {
                        // Test if the delete was succesfull
                        casper.test.assertExists('#oae-notification-container > .alert-success', 'Successfully deleted the link.');
                    });
                });
            });
        });
    });
};

casper.start('http://test.oae.com', function() {
    var user1 = null;
    // Create a user
    userUtil().createUsers(1, function(users) {
        user1 = users[0];
    });

    // Log in
    casper.then(function() {
        userUtil().doLogIn(user1.username, 'password');
    });

    // Make the discussion to delete
    var discussion1 = null;
    casper.then(function() {
        discussionUtil().createDiscussion(1, function(discussions) {
            discussion1 = discussions[0];

            var document1 = null;
            // Make the document to delete
            casper.then(function() {
                collabDocUtil().createCollabDoc(function(document) {
                    document1 = document;

                    // Make the file to delete
                    var fileUrl1 = null;
                    casper.then(function() {
                        contentUtil().createFile(function(fileUrl) {
                            fileUrl1 = fileUrl;
                        });
                    });

                    // Make the link to delete
                    var link1 = null;
                    casper.then(function() {
                        contentUtil().createLink(function(link) {
                            link1 = link;

                            casper.thenOpen('http://test.oae.com/me/library', function() {

                                // Verify discussion deletion
                                casper.then(function() {
                                    casper.echo('Verify the deletion of a discussion.');
                                    verifyDeleteDiscussions(discussion1);
                                });

                                // Remove the last made content first, so the next one will be the first in the list
                                // Verify link deletion
                                casper.then(function() {
                                    casper.echo('Verify the deletion of a link')
                                    verifyDeleteLinks(link1);
                                });

                                // Verify file deletion
                                casper.then(function() {
                                    casper.echo('Verify the deletion of a file.');
                                    verifyDeleteFiles(fileUrl1);
                                });

                                // Verify document deletion
                                casper.then(function() {
                                    casper.echo('Verify the deletion of a document');
                                    verifyDeleteDocuments(document1);
                                });
                            });
                        });
                    });


                    // Log out again
                    casper.then(function() {
                        userUtil().doLogOut();
                    });
                });
            });

        });
    });
});

casper.run(function() {
    casper.test.done();
});
