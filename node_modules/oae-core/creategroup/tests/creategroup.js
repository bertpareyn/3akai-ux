casper.test.comment('Widget - Create group');

/**
 * Open the create group modal with assertions
 */
var verifyOpenCreateGroup = function() {
    casper.waitForSelector('.oae-clip-secondary .oae-clip-content > button', function() {
        casper.click('.oae-clip-secondary .oae-clip-content > button');
        casper.test.assertExists('.oae-trigger-creategroup', 'Create group trigger exists');
        casper.click('.oae-trigger-creategroup');
        casper.wait(1000, function() {
            casper.test.assertVisible('#creategroup-modal', 'Create group pane is showing after trigger');
            casper.click('.oae-clip-secondary .oae-clip-content > button');
        });
    });
};

/**
 * Open the create group modal
 */
var openCreateGroup = function() {
    casper.waitForSelector('.oae-clip-secondary .oae-clip-content > button', function() {
        casper.click('.oae-clip-secondary .oae-clip-content > button');
        casper.click('.oae-trigger-creategroup');
        casper.wait(1000, function() {
            casper.click('.oae-clip-secondary .oae-clip-content > button');
        });
    });
};

/**
 * Goes through the workflow of creating a group
 */
var verifyCreateGroup = function() {
    // Verify the form is present
    casper.test.assertExists('form#creategroup-form', 'The create group form is present');
    casper.test.assertExists('#creategroup-name', 'The group name field is present');
    // Fill the form
    casper.fill('form#creategroup-form', {
        'creategroup-name': 'CasperJS test group'
    }, false);

    // Verify the 'create group' button is present
    casper.test.assertExists('form#creategroup-form button[type="submit"]', 'The \'Create group\' button is present');
    // Click the submit button
    casper.click('form#creategroup-form button[type="submit"]');
    // Wait for a second and verify that the user was redirected to the group
    casper.wait(1000, function() {
        casper.test.assertVisible('#group-clip-container', 'Group profile is shown after creation of the group');
        casper.test.assertSelectorHasText('#group-clip-container h1', 'CasperJS test group', 'Title matches \'CasperJS test group\'');
    });
};

/**
 * Verify the form validation by checking the following:
 *     - Try submitting a form without putting in a title
 */
var verifyCreateGroupValidation = function() {
    // Fill the form
    casper.fill('form#creategroup-form', {
        'creategroup-name': ''
    }, false);
    // Click the submit button
    casper.click('form#creategroup-form button[type="submit"]');
    // Verify that an error label is shown
    casper.test.assertExists('#creategroup-name-error', 'Create group form successfully validated empty form');
};

casper.start('http://cam.oae.com', function() {
    // Create a couple of users to test creategroup with
    var user1 = null;
    userUtil().createUsers(1, function(users) {
        user1 = users[0];
    });

    // Login with that user
    casper.then(function() {
        userUtil().doLogIn(user1.username, 'password');
    });

    // Open the creategroup modal
    casper.then(function() {
        casper.echo('Verify open create group modal', 'INFO');
        verifyOpenCreateGroup();
    });

    // Create a group
    casper.then(function() {
        casper.echo('Verify create group', 'INFO');
        verifyCreateGroup();
    });

    // Verify the group form validation
    casper.thenOpen('http://cam.oae.com/me', function() {
        casper.echo('Verify create group validation', 'INFO');
        casper.then(openCreateGroup);
        casper.then(verifyCreateGroupValidation);
    });

    // Log out at the end of the test
    casper.then(function() {
        userUtil().doLogOut();
    });
});

casper.run(function() {
    this.test.done();
});
