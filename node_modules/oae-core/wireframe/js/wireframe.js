/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid, showSettings, widgetData) {

        // The widget container
        var $rootel = $('#' + uid);

        var folderContent = null;

        /**
         * Show the content item that was clicked
         */
        var showClickedContent = function() {
            var clickedContentId = $(this).data('id');
            var clickedContent = _.find(folderContent, function(content) {
                return clickedContentId === content.id;
            });

            // If the page hasn't been rendered before render it as new,
            // otherwise unhide the rendered page
            $('.wireframe-page', $rootel).hide();
            if ($('.wireframe-page[data-id="' + clickedContent.id + '"]', $rootel).length) {
                $('.wireframe-page[data-id="' + clickedContent.id + '"]', $rootel).show();
            } else {
                $('#wireframe-page-container').append(oae.api.util.template().render($('#wireframe-page-template', $rootel), {
                    'content': clickedContent
                }));
            }
        };

        /**
         * Render the list of content in the folder
         */
        var renderFolderContent = function() {
            oae.api.util.template().render($('#wireframe-contents-list-template', $rootel), {
                'folderContent': folderContent,
                'displayOptions': {
                    'addLink': false,
                    'metadata': false
                }
            }, $('#wireframe-contents-list-container', $rootel));
        };

        /**
         * Get the list of content in the folder
         */
        var getFolderContent = function() {
            var url = '/api/folder/' + widgetData.context.id + '/library';
            $.ajax({
                'url': url,
                'type': 'GET',
                'success': function(data) {
                    folderContent = data.results;
                    renderFolderContent();
                }
            });
        };

        /**
         * Add binding to various elements in the wireframe widget
         */
        var addBinding = function() {
            $rootel.on('click', '#wireframe-contents-list-container ul li', showClickedContent);
        };

        /**
         * Set up the wireframe widget
         */
        var setUpWireframe = function() {
            getFolderContent();
            addBinding();
        };

        setUpWireframe();

    };
});
